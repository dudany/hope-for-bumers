import os
import shutil
from mock import patch
from pipelines.unemployment_etl.create_mirror_table.mirror_tables import write_mirror_table
from pipelines.unemployment_etl.raw_data_ingestion.ingestion_dumper import ingest_raw_data
from pipelines.unemployment_etl.tests.test_expected import EXPECTED_RAW_DATA
from pipelines.unemployment_etl.utils.unemployment_utils import create_pipeline_spark_context, prepare_datalake, \
    create_dir


class mockedApiResponse:
    text = """{"status": "REQUEST_SUCCEEDED", "responseTime": 292, "message": [], "Results": {"series": [{"seriesID": "LAUCT395688200000003", "data": [{"year": "2021", "period": "M12", "periodName": "December", "value": "4.1", "footnotes": [{"code": "T", "text": "Data were subject to revision on April 15, 2022."}]}, {"year": "2021", "period": "M11", "periodName": "November", "value": "3.8", "footnotes": [{"code": "T", "text": "Data were subject to revision on April 15, 2022."}]}, {"year": "2021", "period": "M10", "periodName": "October", "value": "3.9", "footnotes": [{"code": "T", "text": "Data were subject to revision on April 15, 2022."}]}, {"year": "2021", "period": "M09", "periodName": "September", "value": "4.6", "footnotes": [{"code": "T", "text": "Data were subject to revision on April 15, 2022."}]}, {"year": "2021", "period": "M08", "periodName": "August", "value": "5.1", "footnotes": [{"code": "T", "text": "Data were subject to revision on April 15, 2022."}]}, {"year": "2021", "period": "M07", "periodName": "July", "value": "5.7", "footnotes": [{"code": "T", "text": "Data were subject to revision on April 15, 2022."}]}, {"year": "2021", "period": "M06", "periodName": "June", "value": "6.3", "footnotes": [{"code": "T", "text": "Data were subject to revision on April 15, 2022."}]}, {"year": "2021", "period": "M05", "periodName": "May", "value": "5.8", "footnotes": [{"code": "T", "text": "Data were subject to revision on April 15, 2022."}]}, {"year": "2021", "period": "M04", "periodName": "April", "value": "5.3", "footnotes": [{"code": "T", "text": "Data were subject to revision on April 15, 2022."}]}, {"year": "2021", "period": "M03", "periodName": "March", "value": "6.0", "footnotes": [{"code": "T", "text": "Data were subject to revision on April 15, 2022."}]}, {"year": "2021", "period": "M02", "periodName": "February", "value": "6.4", "footnotes": [{"code": "T", "text": "Data were subject to revision on April 15, 2022."}]}, {"year": "2021", "period": "M01", "periodName": "January", "value": "6.3", "footnotes": [{"code": "T", "text": "Data were subject to revision on April 15, 2022."}]}, {"year": "2020", "period": "M12", "periodName": "December", "value": "5.3", "footnotes": [{"code": "T", "text": "Data were subject to revision on April 15, 2022."}]}, {"year": "2020", "period": "M11", "periodName": "November", "value": "5.6", "footnotes": [{"code": "T", "text": "Data were subject to revision on April 15, 2022."}]}, {"year": "2020", "period": "M10", "periodName": "October", "value": "6.1", "footnotes": [{"code": "T", "text": "Data were subject to revision on April 15, 2022."}]}, {"year": "2020", "period": "M09", "periodName": "September", "value": "7.8", "footnotes": [{"code": "T", "text": "Data were subject to revision on April 15, 2022."}]}, {"year": "2020", "period": "M08", "periodName": "August", "value": "8.5", "footnotes": [{"code": "T", "text": "Data were subject to revision on April 15, 2022."}]}, {"year": "2020", "period": "M07", "periodName": "July", "value": "10.9", "footnotes": [{"code": "T", "text": "Data were subject to revision on April 15, 2022."}]}, {"year": "2020", "period": "M06", "periodName": "June", "value": "12.9", "footnotes": [{"code": "T", "text": "Data were subject to revision on April 15, 2022."}]}, {"year": "2020", "period": "M05", "periodName": "May", "value": "16.6", "footnotes": [{"code": "T", "text": "Data were subject to revision on April 15, 2022."}]}, {"year": "2020", "period": "M04", "periodName": "April", "value": "22.1", "footnotes": [{"code": "T", "text": "Data were subject to revision on April 15, 2022."}]}, {"year": "2020", "period": "M03", "periodName": "March", "value": "4.6", "footnotes": [{"code": "T", "text": "Data were subject to revision on April 15, 2022."}]}, {"year": "2020", "period": "M02", "periodName": "February", "value": "4.4", "footnotes": [{"code": "T", "text": "Data were subject to revision on April 15, 2022."}]}, {"year": "2020", "period": "M01", "periodName": "January", "value": "4.2", "footnotes": [{"code": "T", "text": "Data were subject to revision on April 15, 2022."}]}, {"year": "2019", "period": "M12", "periodName": "December", "value": "3.4", "footnotes": [{"code": "T", "text": "Data were subject to revision on April 15, 2022."}]}, {"year": "2019", "period": "M11", "periodName": "November", "value": "3.2", "footnotes": [{"code": "T", "text": "Data were subject to revision on April 15, 2022."}]}, {"year": "2019", "period": "M10", "periodName": "October", "value": "3.0", "footnotes": [{"code": "T", "text": "Data were subject to revision on April 15, 2022."}]}, {"year": "2019", "period": "M09", "periodName": "September", "value": "3.3", "footnotes": [{"code": "T", "text": "Data were subject to revision on April 15, 2022."}]}, {"year": "2019", "period": "M08", "periodName": "August", "value": "3.6", "footnotes": [{"code": "T", "text": "Data were subject to revision on April 15, 2022."}]}, {"year": "2019", "period": "M07", "periodName": "July", "value": "4.2", "footnotes": [{"code": "T", "text": "Data were subject to revision on April 15, 2022."}]}, {"year": "2019", "period": "M06", "periodName": "June", "value": "4.1", "footnotes": [{"code": "T", "text": "Data were subject to revision on April 15, 2022."}]}, {"year": "2019", "period": "M05", "periodName": "May", "value": "3.5", "footnotes": [{"code": "T", "text": "Data were subject to revision on April 15, 2022."}]}, {"year": "2019", "period": "M04", "periodName": "April", "value": "3.3", "footnotes": [{"code": "T", "text": "Data were subject to revision on April 15, 2022."}]}, {"year": "2019", "period": "M03", "periodName": "March", "value": "3.9", "footnotes": [{"code": "T", "text": "Data were subject to revision on April 15, 2022."}]}, {"year": "2019", "period": "M02", "periodName": "February", "value": "4.4", "footnotes": [{"code": "T", "text": "Data were subject to revision on April 15, 2022."}]}, {"year": "2019", "period": "M01", "periodName": "January", "value": "4.4", "footnotes": [{"code": "T", "text": "Data were subject to revision on April 15, 2022."}]}]}, {"seriesID": "LAUCT394713800000003", "data": [{"year": "2021", "period": "M12", "periodName": "December", "value": "4.7", "footnotes": [{"code": "T", "text": "Data were subject to revision on April 15, 2022."}]}, {"year": "2021", "period": "M11", "periodName": "November", "value": "5.0", "footnotes": [{"code": "T", "text": "Data were subject to revision on April 15, 2022."}]}, {"year": "2021", "period": "M10", "periodName": "October", "value": "5.4", "footnotes": [{"code": "T", "text": "Data were subject to revision on April 15, 2022."}]}, {"year": "2021", "period": "M09", "periodName": "September", "value": "6.0", "footnotes": [{"code": "T", "text": "Data were subject to revision on April 15, 2022."}]}, {"year": "2021", "period": "M08", "periodName": "August", "value": "6.9", "footnotes": [{"code": "T", "text": "Data were subject to revision on April 15, 2022."}]}, {"year": "2021", "period": "M07", "periodName": "July", "value": "7.0", "footnotes": [{"code": "T", "text": "Data were subject to revision on April 15, 2022."}]}, {"year": "2021", "period": "M06", "periodName": "June", "value": "7.9", "footnotes": [{"code": "T", "text": "Data were subject to revision on April 15, 2022."}]}, {"year": "2021", "period": "M05", "periodName": "May", "value": "7.1", "footnotes": [{"code": "T", "text": "Data were subject to revision on April 15, 2022."}]}, {"year": "2021", "period": "M04", "periodName": "April", "value": "7.9", "footnotes": [{"code": "T", "text": "Data were subject to revision on April 15, 2022."}]}, {"year": "2021", "period": "M03", "periodName": "March", "value": "7.4", "footnotes": [{"code": "T", "text": "Data were subject to revision on April 15, 2022."}]}, {"year": "2021", "period": "M02", "periodName": "February", "value": "8.3", "footnotes": [{"code": "T", "text": "Data were subject to revision on April 15, 2022."}]}, {"year": "2021", "period": "M01", "periodName": "January", "value": "9.1", "footnotes": [{"code": "T", "text": "Data were subject to revision on April 15, 2022."}]}, {"year": "2020", "period": "M12", "periodName": "December", "value": "7.9", "footnotes": [{"code": "T", "text": "Data were subject to revision on April 15, 2022."}]}, {"year": "2020", "period": "M11", "periodName": "November", "value": "7.4", "footnotes": [{"code": "T", "text": "Data were subject to revision on April 15, 2022."}]}, {"year": "2020", "period": "M10", "periodName": "October", "value": "8.2", "footnotes": [{"code": "T", "text": "Data were subject to revision on April 15, 2022."}]}, {"year": "2020", "period": "M09", "periodName": "September", "value": "9.9", "footnotes": [{"code": "T", "text": "Data were subject to revision on April 15, 2022."}]}, {"year": "2020", "period": "M08", "periodName": "August", "value": "10.3", "footnotes": [{"code": "T", "text": "Data were subject to revision on April 15, 2022."}]}, {"year": "2020", "period": "M07", "periodName": "July", "value": "13.0", "footnotes": [{"code": "T", "text": "Data were subject to revision on April 15, 2022."}]}, {"year": "2020", "period": "M06", "periodName": "June", "value": "14.7", "footnotes": [{"code": "T", "text": "Data were subject to revision on April 15, 2022."}]}, {"year": "2020", "period": "M05", "periodName": "May", "value": "19.9", "footnotes": [{"code": "T", "text": "Data were subject to revision on April 15, 2022."}]}, {"year": "2020", "period": "M04", "periodName": "April", "value": "22.8", "footnotes": [{"code": "T", "text": "Data were subject to revision on April 15, 2022."}]}, {"year": "2020", "period": "M03", "periodName": "March", "value": "6.7", "footnotes": [{"code": "T", "text": "Data were subject to revision on April 15, 2022."}]}, {"year": "2020", "period": "M02", "periodName": "February", "value": "6.0", "footnotes": [{"code": "T", "text": "Data were subject to revision on April 15, 2022."}]}, {"year": "2020", "period": "M01", "periodName": "January", "value": "6.6", "footnotes": [{"code": "T", "text": "Data were subject to revision on April 15, 2022."}]}, {"year": "2019", "period": "M12", "periodName": "December", "value": "5.2", "footnotes": [{"code": "T", "text": "Data were subject to revision on April 15, 2022."}]}, {"year": "2019", "period": "M11", "periodName": "November", "value": "4.9", "footnotes": [{"code": "T", "text": "Data were subject to revision on April 15, 2022."}]}, {"year": "2019", "period": "M10", "periodName": "October", "value": "4.8", "footnotes": [{"code": "T", "text": "Data were subject to revision on April 15, 2022."}]}, {"year": "2019", "period": "M09", "periodName": "September", "value": "5.0", "footnotes": [{"code": "T", "text": "Data were subject to revision on April 15, 2022."}]}, {"year": "2019", "period": "M08", "periodName": "August", "value": "5.3", "footnotes": [{"code": "T", "text": "Data were subject to revision on April 15, 2022."}]}, {"year": "2019", "period": "M07", "periodName": "July", "value": "5.5", "footnotes": [{"code": "T", "text": "Data were subject to revision on April 15, 2022."}]}, {"year": "2019", "period": "M06", "periodName": "June", "value": "5.2", "footnotes": [{"code": "T", "text": "Data were subject to revision on April 15, 2022."}]}, {"year": "2019", "period": "M05", "periodName": "May", "value": "4.3", "footnotes": [{"code": "T", "text": "Data were subject to revision on April 15, 2022."}]}, {"year": "2019", "period": "M04", "periodName": "April", "value": "4.3", "footnotes": [{"code": "T", "text": "Data were subject to revision on April 15, 2022."}]}, {"year": "2019", "period": "M03", "periodName": "March", "value": "5.1", "footnotes": [{"code": "T", "text": "Data were subject to revision on April 15, 2022."}]}, {"year": "2019", "period": "M02", "periodName": "February", "value": "5.5", "footnotes": [{"code": "T", "text": "Data were subject to revision on April 15, 2022."}]}, {"year": "2019", "period": "M01", "periodName": "January", "value": "6.3", "footnotes": [{"code": "T", "text": "Data were subject to revision on April 15, 2022."}]}]}, {"seriesID": "LAUCT485235600000003", "data": [{"year": "2021", "period": "M12", "periodName": "December", "value": "3.4", "footnotes": [{"code": "T", "text": "Data were subject to revision on April 15, 2022."}]}, {"year": "2021", "period": "M11", "periodName": "November", "value": "3.8", "footnotes": [{"code": "T", "text": "Data were subject to revision on April 15, 2022."}]}, {"year": "2021", "period": "M10", "periodName": "October", "value": "3.8", "footnotes": [{"code": "T", "text": "Data were subject to revision on April 15, 2022."}]}, {"year": "2021", "period": "M09", "periodName": "September", "value": "4.1", "footnotes": [{"code": "T", "text": "Data were subject to revision on April 15, 2022."}]}, {"year": "2021", "period": "M08", "periodName": "August", "value": "4.3", "footnotes": [{"code": "T", "text": "Data were subject to revision on April 15, 2022."}]}, {"year": "2021", "period": "M07", "periodName": "July", "value": "4.7", "footnotes": [{"code": "T", "text": "Data were subject to revision on April 15, 2022."}]}, {"year": "2021", "period": "M06", "periodName": "June", "value": "5.3", "footnotes": [{"code": "T", "text": "Data were subject to revision on April 15, 2022."}]}, {"year": "2021", "period": "M05", "periodName": "May", "value": "4.6", "footnotes": [{"code": "T", "text": "Data were subject to revision on April 15, 2022."}]}, {"year": "2021", "period": "M04", "periodName": "April", "value": "5.0", "footnotes": [{"code": "T", "text": "Data were subject to revision on April 15, 2022."}]}, {"year": "2021", "period": "M03", "periodName": "March", "value": "5.4", "footnotes": [{"code": "T", "text": "Data were subject to revision on April 15, 2022."}]}, {"year": "2021", "period": "M02", "periodName": "February", "value": "5.8", "footnotes": [{"code": "T", "text": "Data were subject to revision on April 15, 2022."}]}, {"year": "2021", "period": "M01", "periodName": "January", "value": "5.8", "footnotes": [{"code": "T", "text": "Data were subject to revision on April 15, 2022."}]}, {"year": "2020", "period": "M12", "periodName": "December", "value": "5.4", "footnotes": [{"code": "T", "text": "Data were subject to revision on April 15, 2022."}]}, {"year": "2020", "period": "M11", "periodName": "November", "value": "5.4", "footnotes": [{"code": "T", "text": "Data were subject to revision on April 15, 2022."}]}, {"year": "2020", "period": "M10", "periodName": "October", "value": "5.2", "footnotes": [{"code": "T", "text": "Data were subject to revision on April 15, 2022."}]}, {"year": "2020", "period": "M09", "periodName": "September", "value": "6.0", "footnotes": [{"code": "T", "text": "Data were subject to revision on April 15, 2022."}]}, {"year": "2020", "period": "M08", "periodName": "August", "value": "6.5", "footnotes": [{"code": "T", "text": "Data were subject to revision on April 15, 2022."}]}, {"year": "2020", "period": "M07", "periodName": "July", "value": "8.3", "footnotes": [{"code": "T", "text": "Data were subject to revision on April 15, 2022."}]}, {"year": "2020", "period": "M06", "periodName": "June", "value": "9.5", "footnotes": [{"code": "T", "text": "Data were subject to revision on April 15, 2022."}]}, {"year": "2020", "period": "M05", "periodName": "May", "value": "11.1", "footnotes": [{"code": "T", "text": "Data were subject to revision on April 15, 2022."}]}, {"year": "2020", "period": "M04", "periodName": "April", "value": "11.8", "footnotes": [{"code": "T", "text": "Data were subject to revision on April 15, 2022."}]}, {"year": "2020", "period": "M03", "periodName": "March", "value": "4.7", "footnotes": [{"code": "T", "text": "Data were subject to revision on April 15, 2022."}]}, {"year": "2020", "period": "M02", "periodName": "February", "value": "2.9", "footnotes": [{"code": "T", "text": "Data were subject to revision on April 15, 2022."}]}, {"year": "2020", "period": "M01", "periodName": "January", "value": "3.0", "footnotes": [{"code": "T", "text": "Data were subject to revision on April 15, 2022."}]}, {"year": "2019", "period": "M12", "periodName": "December", "value": "2.7", "footnotes": [{"code": "T", "text": "Data were subject to revision on April 15, 2022."}]}, {"year": "2019", "period": "M11", "periodName": "November", "value": "2.9", "footnotes": [{"code": "T", "text": "Data were subject to revision on April 15, 2022."}]}, {"year": "2019", "period": "M10", "periodName": "October", "value": "2.8", "footnotes": [{"code": "T", "text": "Data were subject to revision on April 15, 2022."}]}, {"year": "2019", "period": "M09", "periodName": "September", "value": "3.0", "footnotes": [{"code": "T", "text": "Data were subject to revision on April 15, 2022."}]}, {"year": "2019", "period": "M08", "periodName": "August", "value": "3.2", "footnotes": [{"code": "T", "text": "Data were subject to revision on April 15, 2022."}]}, {"year": "2019", "period": "M07", "periodName": "July", "value": "3.2", "footnotes": [{"code": "T", "text": "Data were subject to revision on April 15, 2022."}]}, {"year": "2019", "period": "M06", "periodName": "June", "value": "3.1", "footnotes": [{"code": "T", "text": "Data were subject to revision on April 15, 2022."}]}, {"year": "2019", "period": "M05", "periodName": "May", "value": "2.8", "footnotes": [{"code": "T", "text": "Data were subject to revision on April 15, 2022."}]}, {"year": "2019", "period": "M04", "periodName": "April", "value": "2.7", "footnotes": [{"code": "T", "text": "Data were subject to revision on April 15, 2022."}]}, {"year": "2019", "period": "M03", "periodName": "March", "value": "3.1", "footnotes": [{"code": "T", "text": "Data were subject to revision on April 15, 2022."}]}, {"year": "2019", "period": "M02", "periodName": "February", "value": "3.2", "footnotes": [{"code": "T", "text": "Data were subject to revision on April 15, 2022."}]}, {"year": "2019", "period": "M01", "periodName": "January", "value": "3.5", "footnotes": [{"code": "T", "text": "Data were subject to revision on April 15, 2022."}]}]}, {"seriesID": "LAUCN271410000000003", "data": [{"year": "2021", "period": "M12", "periodName": "December", "value": "2.8", "footnotes": [{"code": "T", "text": "Data were subject to revision on April 15, 2022."}]}, {"year": "2021", "period": "M11", "periodName": "November", "value": "2.1", "footnotes": [{"code": "T", "text": "Data were subject to revision on April 15, 2022."}]}, {"year": "2021", "period": "M10", "periodName": "October", "value": "2.2", "footnotes": [{"code": "T", "text": "Data were subject to revision on April 15, 2022."}]}, {"year": "2021", "period": "M09", "periodName": "September", "value": "2.5", "footnotes": [{"code": "T", "text": "Data were subject to revision on April 15, 2022."}]}, {"year": "2021", "period": "M08", "periodName": "August", "value": "2.9", "footnotes": [{"code": "T", "text": "Data were subject to revision on April 15, 2022."}]}, {"year": "2021", "period": "M07", "periodName": "July", "value": "2.9", "footnotes": [{"code": "T", "text": "Data were subject to revision on April 15, 2022."}]}, {"year": "2021", "period": "M06", "periodName": "June", "value": "3.6", "footnotes": [{"code": "T", "text": "Data were subject to revision on April 15, 2022."}]}, {"year": "2021", "period": "M05", "periodName": "May", "value": "3.0", "footnotes": [{"code": "T", "text": "Data were subject to revision on April 15, 2022."}]}, {"year": "2021", "period": "M04", "periodName": "April", "value": "3.7", "footnotes": [{"code": "T", "text": "Data were subject to revision on April 15, 2022."}]}, {"year": "2021", "period": "M03", "periodName": "March", "value": "4.8", "footnotes": [{"code": "T", "text": "Data were subject to revision on April 15, 2022."}]}, {"year": "2021", "period": "M02", "periodName": "February", "value": "5.3", "footnotes": [{"code": "T", "text": "Data were subject to revision on April 15, 2022."}]}, {"year": "2021", "period": "M01", "periodName": "January", "value": "5.7", "footnotes": [{"code": "T", "text": "Data were subject to revision on April 15, 2022."}]}, {"year": "2020", "period": "M12", "periodName": "December", "value": "5.2", "footnotes": [{"code": "T", "text": "Data were subject to revision on April 15, 2022."}]}, {"year": "2020", "period": "M11", "periodName": "November", "value": "4.1", "footnotes": [{"code": "T", "text": "Data were subject to revision on April 15, 2022."}]}, {"year": "2020", "period": "M10", "periodName": "October", "value": "4.2", "footnotes": [{"code": "T", "text": "Data were subject to revision on April 15, 2022."}]}, {"year": "2020", "period": "M09", "periodName": "September", "value": "4.8", "footnotes": [{"code": "T", "text": "Data were subject to revision on April 15, 2022."}]}, {"year": "2020", "period": "M08", "periodName": "August", "value": "5.4", "footnotes": [{"code": "T", "text": "Data were subject to revision on April 15, 2022."}]}, {"year": "2020", "period": "M07", "periodName": "July", "value": "7.1", "footnotes": [{"code": "T", "text": "Data were subject to revision on April 15, 2022."}]}, {"year": "2020", "period": "M06", "periodName": "June", "value": "8.3", "footnotes": [{"code": "T", "text": "Data were subject to revision on April 15, 2022."}]}, {"year": "2020", "period": "M05", "periodName": "May", "value": "10.5", "footnotes": [{"code": "T", "text": "Data were subject to revision on April 15, 2022."}]}, {"year": "2020", "period": "M04", "periodName": "April", "value": "9.1", "footnotes": [{"code": "T", "text": "Data were subject to revision on April 15, 2022."}]}, {"year": "2020", "period": "M03", "periodName": "March", "value": "6.0", "footnotes": [{"code": "T", "text": "Data were subject to revision on April 15, 2022."}]}, {"year": "2020", "period": "M02", "periodName": "February", "value": "5.0", "footnotes": [{"code": "T", "text": "Data were subject to revision on April 15, 2022."}]}, {"year": "2020", "period": "M01", "periodName": "January", "value": "5.2", "footnotes": [{"code": "T", "text": "Data were subject to revision on April 15, 2022."}]}, {"year": "2019", "period": "M12", "periodName": "December", "value": "4.3", "footnotes": [{"code": "T", "text": "Data were subject to revision on April 15, 2022."}]}, {"year": "2019", "period": "M11", "periodName": "November", "value": "3.1", "footnotes": [{"code": "T", "text": "Data were subject to revision on April 15, 2022."}]}, {"year": "2019", "period": "M10", "periodName": "October", "value": "2.8", "footnotes": [{"code": "T", "text": "Data were subject to revision on April 15, 2022."}]}, {"year": "2019", "period": "M09", "periodName": "September", "value": "2.8", "footnotes": [{"code": "T", "text": "Data were subject to revision on April 15, 2022."}]}, {"year": "2019", "period": "M08", "periodName": "August", "value": "3.1", "footnotes": [{"code": "T", "text": "Data were subject to revision on April 15, 2022."}]}, {"year": "2019", "period": "M07", "periodName": "July", "value": "3.2", "footnotes": [{"code": "T", "text": "Data were subject to revision on April 15, 2022."}]}, {"year": "2019", "period": "M06", "periodName": "June", "value": "3.5", "footnotes": [{"code": "T", "text": "Data were subject to revision on April 15, 2022."}]}, {"year": "2019", "period": "M05", "periodName": "May", "value": "3.0", "footnotes": [{"code": "T", "text": "Data were subject to revision on April 15, 2022."}]}, {"year": "2019", "period": "M04", "periodName": "April", "value": "3.7", "footnotes": [{"code": "T", "text": "Data were subject to revision on April 15, 2022."}]}, {"year": "2019", "period": "M03", "periodName": "March", "value": "4.8", "footnotes": [{"code": "T", "text": "Data were subject to revision on April 15, 2022."}]}, {"year": "2019", "period": "M02", "periodName": "February", "value": "4.9", "footnotes": [{"code": "T", "text": "Data were subject to revision on April 15, 2022."}]}, {"year": "2019", "period": "M01", "periodName": "January", "value": "5.4", "footnotes": [{"code": "T", "text": "Data were subject to revision on April 15, 2022."}]}]}, {"seriesID": "LAUCN420410000000003", "data": [{"year": "2021", "period": "M12", "periodName": "December", "value": "3.1", "footnotes": [{"code": "T", "text": "Data were subject to revision on April 15, 2022."}]}, {"year": "2021", "period": "M11", "periodName": "November", "value": "3.3", "footnotes": [{"code": "T", "text": "Data were subject to revision on April 15, 2022."}]}, {"year": "2021", "period": "M10", "periodName": "October", "value": "3.9", "footnotes": [{"code": "T", "text": "Data were subject to revision on April 15, 2022."}]}, {"year": "2021", "period": "M09", "periodName": "September", "value": "4.0", "footnotes": [{"code": "T", "text": "Data were subject to revision on April 15, 2022."}]}, {"year": "2021", "period": "M08", "periodName": "August", "value": "5.1", "footnotes": [{"code": "T", "text": "Data were subject to revision on April 15, 2022."}]}, {"year": "2021", "period": "M07", "periodName": "July", "value": "5.4", "footnotes": [{"code": "T", "text": "Data were subject to revision on April 15, 2022."}]}, {"year": "2021", "period": "M06", "periodName": "June", "value": "5.2", "footnotes": [{"code": "T", "text": "Data were subject to revision on April 15, 2022."}]}, {"year": "2021", "period": "M05", "periodName": "May", "value": "4.7", "footnotes": [{"code": "T", "text": "Data were subject to revision on April 15, 2022."}]}, {"year": "2021", "period": "M04", "periodName": "April", "value": "4.6", "footnotes": [{"code": "T", "text": "Data were subject to revision on April 15, 2022."}]}, {"year": "2021", "period": "M03", "periodName": "March", "value": "4.9", "footnotes": [{"code": "T", "text": "Data were subject to revision on April 15, 2022."}]}, {"year": "2021", "period": "M02", "periodName": "February", "value": "5.3", "footnotes": [{"code": "T", "text": "Data were subject to revision on April 15, 2022."}]}, {"year": "2021", "period": "M01", "periodName": "January", "value": "5.4", "footnotes": [{"code": "T", "text": "Data were subject to revision on April 15, 2022."}]}, {"year": "2020", "period": "M12", "periodName": "December", "value": "5.6", "footnotes": [{"code": "T", "text": "Data were subject to revision on April 15, 2022."}]}, {"year": "2020", "period": "M11", "periodName": "November", "value": "5.2", "footnotes": [{"code": "T", "text": "Data were subject to revision on April 15, 2022."}]}, {"year": "2020", "period": "M10", "periodName": "October", "value": "5.3", "footnotes": [{"code": "T", "text": "Data were subject to revision on April 15, 2022."}]}, {"year": "2020", "period": "M09", "periodName": "September", "value": "6.1", "footnotes": [{"code": "T", "text": "Data were subject to revision on April 15, 2022."}]}, {"year": "2020", "period": "M08", "periodName": "August", "value": "6.6", "footnotes": [{"code": "T", "text": "Data were subject to revision on April 15, 2022."}]}, {"year": "2020", "period": "M07", "periodName": "July", "value": "8.4", "footnotes": [{"code": "T", "text": "Data were subject to revision on April 15, 2022."}]}, {"year": "2020", "period": "M06", "periodName": "June", "value": "9.1", "footnotes": [{"code": "T", "text": "Data were subject to revision on April 15, 2022."}]}, {"year": "2020", "period": "M05", "periodName": "May", "value": "10.1", "footnotes": [{"code": "T", "text": "Data were subject to revision on April 15, 2022."}]}, {"year": "2020", "period": "M04", "periodName": "April", "value": "11.8", "footnotes": [{"code": "T", "text": "Data were subject to revision on April 15, 2022."}]}, {"year": "2020", "period": "M03", "periodName": "March", "value": "4.2", "footnotes": [{"code": "T", "text": "Data were subject to revision on April 15, 2022."}]}, {"year": "2020", "period": "M02", "periodName": "February", "value": "3.8", "footnotes": [{"code": "T", "text": "Data were subject to revision on April 15, 2022."}]}, {"year": "2020", "period": "M01", "periodName": "January", "value": "3.8", "footnotes": [{"code": "T", "text": "Data were subject to revision on April 15, 2022."}]}, {"year": "2019", "period": "M12", "periodName": "December", "value": "3.2", "footnotes": [{"code": "T", "text": "Data were subject to revision on April 15, 2022."}]}, {"year": "2019", "period": "M11", "periodName": "November", "value": "3.2", "footnotes": [{"code": "T", "text": "Data were subject to revision on April 15, 2022."}]}, {"year": "2019", "period": "M10", "periodName": "October", "value": "3.4", "footnotes": [{"code": "T", "text": "Data were subject to revision on April 15, 2022."}]}, {"year": "2019", "period": "M09", "periodName": "September", "value": "3.4", "footnotes": [{"code": "T", "text": "Data were subject to revision on April 15, 2022."}]}, {"year": "2019", "period": "M08", "periodName": "August", "value": "3.8", "footnotes": [{"code": "T", "text": "Data were subject to revision on April 15, 2022."}]}, {"year": "2019", "period": "M07", "periodName": "July", "value": "4.1", "footnotes": [{"code": "T", "text": "Data were subject to revision on April 15, 2022."}]}, {"year": "2019", "period": "M06", "periodName": "June", "value": "3.7", "footnotes": [{"code": "T", "text": "Data were subject to revision on April 15, 2022."}]}, {"year": "2019", "period": "M05", "periodName": "May", "value": "3.3", "footnotes": [{"code": "T", "text": "Data were subject to revision on April 15, 2022."}]}, {"year": "2019", "period": "M04", "periodName": "April", "value": "2.9", "footnotes": [{"code": "T", "text": "Data were subject to revision on April 15, 2022."}]}, {"year": "2019", "period": "M03", "periodName": "March", "value": "3.4", "footnotes": [{"code": "T", "text": "Data were subject to revision on April 15, 2022."}]}, {"year": "2019", "period": "M02", "periodName": "February", "value": "3.6", "footnotes": [{"code": "T", "text": "Data were subject to revision on April 15, 2022."}]}, {"year": "2019", "period": "M01", "periodName": "January", "value": "3.6", "footnotes": [{"code": "T", "text": "Data were subject to revision on April 15, 2022."}]}]}]}}"""


@patch('pipelines.unemployment_etl.raw_data_ingestion.ingestion_dumper.requests.post')
def test_ingestion(mock_requests_post):
    # test for testing ingestion step
    mock_requests_post.return_value = mockedApiResponse()
    create_dir("test_raw_data_results")
    test_raw_data_path = f"{os.getcwd()}/test_raw_data_results"
    etl_date = {"startyear": "2019", "endyear": "2021"}
    series_id_list = ["LAUCT395688200000003", "LAUCT394713800000003", "LAUCT485235600000003",
                      "LAUCT485235600000003", "LAUCN420410000000003"]
    written_file_path = ingest_raw_data(raw_data_location=test_raw_data_path, date_period=etl_date,
                                        series_list=series_id_list)
    with open(written_file_path) as f:
        actual = f.readlines()
    assert all([a == b for a, b in zip(actual, EXPECTED_RAW_DATA)])


def test_mirror_create():
    # test for mirror creation testing

    # setup of delta table
    spark = create_pipeline_spark_context()
    sql_path = "../create_mirror_table/mirror_table_ddl.sql"
    paths_dict = prepare_datalake(spark, sql_path)
    # write raw data to preprocessed
    test_raw_data_to_process = paths_dict["raw_data"]
    shutil.copy("test_raw_data_to_process/raw_data_22_08_06_16_34_54.json", test_raw_data_to_process)
    test_processed_data_path = paths_dict["processed_data"]
    write_mirror_table(spark, test_raw_data_to_process, test_processed_data_path)

    actual_df = spark.sql("select * from mirror_table")
    expected_df = spark.read.parquet("./test_mirror_table_expc")
    assert (are_dataframes_equal(actual_df, expected_df), "Result is different then expected")


def are_dataframes_equal(df_actual, df_expected):
    return df_actual.subtract(df_expected).rdd.isEmpty()
